function isTabGroupsSupported(){return typeof chrome.tabGroups!=='undefined'&&typeof chrome.tabs.group==='function';}
chrome.runtime.onMessage.addListener((request,sender,sendResponse)=>{if(request.action==='checkTabGroupsSupport'){sendResponse({supported:isTabGroupsSupported()});return false;}if(request.action==='createTabGroups'){if(!isTabGroupsSupported()){sendResponse({success:false,error:'Tab Groups API not supported.',notSupported:true});return false;}createChromeTabGroups(request.groups,request.ungroupedTabIds,request.arrangeGroupsFirst).then(r=>sendResponse(r)).catch(e=>sendResponse({success:false,error:e.message}));return true;}});
async function createChromeTabGroups(groups,ungroupedTabIds=[],arrangeGroupsFirst=true){let successCount=0,errors=[],currentIndex=0;for(const group of groups){if(!group.tabIds||group.tabIds.length===0)continue;try{const validTabIds=[];for(const tabId of group.tabIds){try{const tab=await chrome.tabs.get(tabId);if(tab){const url=tab.url||'';const isInternal=url.startsWith('chrome://')||url.startsWith('chrome-extension://')||url.startsWith('devtools://')||url.startsWith('edge://')||url.startsWith('about://')||url.startsWith('view-source:');if(!isInternal)validTabIds.push(tabId);}}catch(e){}}if(validTabIds.length===0){errors.push(group.name+': No groupable tabs');continue;}if(arrangeGroupsFirst){try{await chrome.tabs.move(validTabIds,{index:currentIndex});currentIndex+=validTabIds.length;}catch(e){}}const groupId=await chrome.tabs.group({tabIds:validTabIds});await chrome.tabGroups.update(groupId,{title:group.name||'Group',color:group.color||'blue',collapsed:false});successCount++;}catch(error){errors.push(group.name+': '+error.message);}}if(arrangeGroupsFirst&&ungroupedTabIds&&ungroupedTabIds.length>0){const validUngroupedIds=[];for(const tabId of ungroupedTabIds){try{const tab=await chrome.tabs.get(tabId);if(tab){const url=tab.url||'';const isInternal=url.startsWith('chrome://')||url.startsWith('chrome-extension://')||url.startsWith('devtools://')||url.startsWith('edge://')||url.startsWith('about://')||url.startsWith('view-source:');if(!isInternal)validUngroupedIds.push(tabId);}}catch(e){}}if(validUngroupedIds.length>0){try{await chrome.tabs.move(validUngroupedIds,{index:-1});}catch(e){}}}return{success:successCount>0,created:successCount,errors};}